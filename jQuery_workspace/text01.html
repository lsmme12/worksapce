<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>전국 시군구 3일치 일기예보</title>
  <style>
    body { font-family: sans-serif; background:#f9f9f9; padding:20px; }
    h1 { color:#0b3d91; }
    input, button { padding:6px 10px; margin:4px; }
    .card { background:#fff; border:1px solid #ddd; border-radius:8px; padding:12px; margin:12px 0; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    .card h3 { margin:0 0 8px 0; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #ddd; padding:6px; text-align:center; font-size:13px; }
    th { background:#f3f6fb; }
  </style>
</head>
<body>
  <h1>전국 시군구 3일치 일기예보</h1>
  <input id="q" type="text" placeholder="예: 강남 / 해운대 / 서울 종로" style="width:250px;">
  <button id="btnSearch">검색</button>

  <div id="result"></div>

<script>
const serviceKey = "c11db438eda216f4b1aa2c9fb04824d89b277859c034bf5a7e9e40c373ad1efc"; // URL 인코딩된 값 권장

async function loadRegions(){
  const res = await fetch("data.json");
  return await res.json();
}

function nearestBaseTime(date=new Date()){
  const times = ["0200","0500","0800","1100","1400","1700","2000","2300"];
  const hhmm = String(date.getHours()).padStart(2,"0")+"00";
  let chosen = times[0];
  for(const t of times){ if(hhmm >= t) chosen = t; }
  let baseDate = date.toISOString().slice(0,10).replace(/-/g,"");
  if(hhmm < times[0]){
    const prev = new Date(date.getTime() - 86400000);
    baseDate = prev.toISOString().slice(0,10).replace(/-/g,"");
    chosen = "2300";
  }
  return {baseDate, baseTime: chosen};
}

function skyText(code){ return {"1":"맑음☀️","3":"구름많음⛅","4":"흐림☁️"}[code] || "정보없음"; }
function ptyText(code){ return {"0":"없음","1":"비","2":"비/눈","3":"눈","5":"빗방울","6":"빗방울눈날림","7":"눈날림"}[code] || ""; }

// 부분 검색 함수
function findRegion(query, regions) {
  const q = query.replace(/\s+/g, "").toLowerCase();
  const keys = Object.keys(regions);
  const matches = keys.filter(name =>
    name.replace(/\s+/g, "").toLowerCase().includes(q)
  );
  if(matches.length === 0) return null;
  if(matches.length > 1) {
    console.log("여러 후보:", matches);
  }
  return matches[0]; // 첫 번째 결과 반환
}

document.getElementById("btnSearch").addEventListener("click", async ()=>{
  const q = document.getElementById("q").value.trim();
  const regions = await loadRegions();
  const match = findRegion(q, regions);

  if(!match){
    alert("검색 결과가 없습니다.");
    return;
  }

  const {nx, ny} = regions[match];
  const {baseDate, baseTime} = nearestBaseTime(new Date());

  const url = `https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getVilageFcst
?serviceKey=${serviceKey}&pageNo=1&numOfRows=1000&dataType=JSON
&base_date=${baseDate}&base_time=${baseTime}&nx=${nx}&ny=${ny}`;

  const res = await fetch(url);
  const data = await res.json();
  const items = data?.response?.body?.items?.item || [];

  // 날짜별 그룹화
  const grouped = {};
  items.forEach(it=>{
    if(!grouped[it.fcstDate]) grouped[it.fcstDate] = [];
    grouped[it.fcstDate].push(it);
  });
  const dates = Object.keys(grouped).sort().slice(0,3);

  let html = `<div class="card"><h3>${match}</h3><p>기준: ${baseDate} ${baseTime}</p></div>`;

  // 요약
  html += `<div class="card"><h3>3일치 요약</h3>`;
  dates.forEach(d=>{
    const arr = grouped[d];
    const tmx = arr.find(x=>x.category==="TMX")?.fcstValue;
    const tmn = arr.find(x=>x.category==="TMN")?.fcstValue;
    const sky = arr.find(x=>x.category==="SKY")?.fcstValue;
    const pops = arr.filter(x=>x.category==="POP").map(x=>+x.fcstValue);
    const rehs = arr.filter(x=>x.category==="REH").map(x=>+x.fcstValue);
    const avg = l => l.length?Math.round(l.reduce((a,b)=>a+b,0)/l.length):"-";
    html += `<p><strong>${d.slice(4,6)}/${d.slice(6,8)}</strong> → 최저 ${tmn??"-"}℃ / 최고 ${tmx??"-"}℃ / 하늘 ${skyText(sky)} / 강수 ${avg(pops)}% / 습도 ${avg(rehs)}%</p>`;
  });
  html += `</div>`;

  // 3시간 간격 상세 (TMP 사용)
  const hourlyMap = {};
  items.filter(it=>["TMP","SKY","PTY","POP","REH"].includes(it.category))
       .forEach(it=>{
         const key=it.fcstDate+it.fcstTime;
         if(!hourlyMap[key]) hourlyMap[key]={date:it.fcstDate,time:it.fcstTime};
         hourlyMap[key][it.category]=it.fcstValue;
       });
  const hourly = Object.values(hourlyMap).sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time));

  html += `<div class="card"><h3>3시간 간격 상세</h3><table><tr>
    <th>날짜</th><th>시각</th><th>기온</th><th>하늘</th><th>강수확률</th><th>습도</th><th>강수형태</th></tr>`;
  hourly.forEach(r=>{
    html += `<tr>
      <td>${r.date.slice(4,6)}/${r.date.slice(6,8)}</td>
      <td>${r.time.slice(0,2)}:${r.time.slice(2)}</td>
      <td>${r.TMP??"-"}℃</td>
      <td>${r.SKY?skyText(r.SKY):"-"}</td>
      <td>${r.POP??"-"}%</td>
      <td>${r.REH??"-"}%</td>
      <td>${r.PTY?ptyText(r.PTY):"-"}</td>
    </tr>`;
  });
  html += `</table></div>`;

  document.getElementById("result").innerHTML = html;
});
</script>
</body>
</html>
